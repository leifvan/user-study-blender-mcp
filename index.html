<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Online-Studie</title>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css">
  <style>
    /* Ensure full-height and remove default margins */
    html, body {
      height: 100%;
      margin: 0;
    }

    /* Center everything in the viewport */
    body {
      display: flex;
      align-items: center;    /* vertikal zentrieren */
      justify-content: center;/* horizontal zentrieren */
      min-height: 100vh;
      padding: 20px;
      font-family: sans-serif;
      text-align: center;
      background: #fff;
    }

    /* Constraining container that stays centered */
    .container {
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    /* Make sure common jsPsych containers are centered */
    #jspsych-target,
    #jspsych,
    .jspsych-display-element,
    .jspsych-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      box-sizing: border-box;
    }

    img {
      border: 1px solid #ccc;
      border-radius: 4px;
      max-width: 100%;
      height: auto;
    }

    /* Make survey forms center their fields */
    .jspsych-survey-form form {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Keep the instruction list nicely constrained but centered */
    ul {
      text-align: left;
      max-width: 600px;
      margin: 0 auto 1rem auto;
    }
  </style>
</head>
<body>
  <!-- Dedicated container for jsPsych so we can keep the page centered -->
  <div class="container" id="jspsych-target"></div>
</body>
<script>
  // ---------- Configuration ----------
  const SAVE_URL = "https://user-study-relay.vercel.app/api/save";

  // ---- Stable participant id across reloads ----
  const PID_KEY = 'participant_id_v1';

  function readUrlParam(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function getOrCreateParticipantId() {
    // Priority: explicit ?pid=… in the URL (nice for Prolific/Sona)
    const pidFromUrl = readUrlParam('pid');
    if (pidFromUrl) {
      localStorage.setItem(PID_KEY, pidFromUrl);
      return pidFromUrl;
    }
    // Fallback: reuse a stored one
    const existing = localStorage.getItem(PID_KEY);
    if (existing) return existing;

    // Generate once for this participant/session
    const fresh = (crypto && crypto.randomUUID) ? crypto.randomUUID() :
                  String(Math.random()).slice(2) + Date.now();
    localStorage.setItem(PID_KEY, fresh);
    return fresh;
  }
  const participant_id = getOrCreateParticipantId();

  // ---------- Init jsPsych (render into #jspsych-target) ----------
  const displayElement = document.getElementById('jspsych-target');
  const jsPsych = initJsPsych({ display_element: displayElement });
  jsPsych.data.addProperties({ participant_id, study: 'image_pairs_v1' });

  // ---------- Stimuli ----------
  const base_images = [
    "bahn.jpg","baum.jpg","bäume.jpg","berg.jpg","berge.jpg",
    "haus.jpg","hütte.jpg","schnee.jpg","turm.jpg","weg.jpg"
  ];

  const result_images = {
    bahn: ["bahn0.png","bahn1.png","bahn2.png","bahn3.png"],
    baum: ["baum0.png","baum1.png","baum2.png","baum3.png"],
    bäume: ["bäume0.png","bäume1.png","bäume2.png","bäume3.png"],
    berg: ["berg0.png","berg1.png","berg2.png","berg3.png"],
    berge: ["berge0.png","berge1.png","berge2.png","berge3.png"],
    haus: ["haus0.png","haus1.png","haus2.png","haus3.png"],
    hütte: ["hütte0.png","hütte1.png","hütte2.png","hütte3.png"],
    schnee: ["schnee0.png","schnee1.png","schnee2.png","schnee3.png"],
    turm: ["turm0.png","turm1.png","turm2.png","turm3.png"],
    weg: ["weg0.png","weg1.png","weg2.png","weg3.png"]
  };

  // ---------- Trials vorbereiten ----------
  function createTrials(){
    let trials = [];
    base_images.forEach(base => {
      let key = base.replace(".jpg","");
      let res = result_images[key];
      let pairs = [
        [res[0],res[1]],[res[0],res[2]],[res[0],res[3]],
        [res[1],res[2]],[res[1],res[3]],[res[2],res[3]]
      ];
      jsPsych.randomization.shuffle(pairs).slice(0,6).forEach(pair => {
        trials.push({
          type: "trial",
          base: base,
          option1: pair[0],
          option2: pair[1]
        });
      });
    });
    return jsPsych.randomization.shuffle(trials);
  }

  // ---- persist trials across reloads ----
  const TRIALS_KEY = 'accumulated_trials_v1';

  function appendTrials(trialsArray) {
    try {
      const prev = JSON.parse(localStorage.getItem(TRIALS_KEY) || '[]');
      const next = prev.concat(trialsArray || []);
      localStorage.setItem(TRIALS_KEY, JSON.stringify(next));
    } catch (_) { /* ignore */ }
  }

  function getAccumulatedTrials() {
    try { return JSON.parse(localStorage.getItem(TRIALS_KEY) || '[]'); }
    catch { return []; }
  }

  function clearAccumulatedTrials() {
    localStorage.removeItem(TRIALS_KEY);
  }

  // ---------- Initialisierung LocalStorage ----------
  if(!localStorage.getItem("all_steps")){
    let steps = [];
    steps.push({ type: "consent" });
    steps.push({ type: "intro" });
    steps.push({ type: "demographics" });
    steps.push(...createTrials());
    steps.push({ type: "feedback" }); // Feedback-Schritt direkt vor Ende
    steps.push({ type: "end" });

    localStorage.setItem("all_steps", JSON.stringify(steps));
    localStorage.setItem("current_index", "0");
  }

  let all_steps = JSON.parse(localStorage.getItem("all_steps"));
  let index = parseInt(localStorage.getItem("current_index"),10);

  // ---------- Ablauf ----------
  if(index >= all_steps.length){
    // Alles fertig → strukturierte Trials an Vercel schicken
    const trials = getAccumulatedTrials().concat(jsPsych.data.get().values());

    fetch(SAVE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        study: "image_pairs_v1",   // optional label
        trials                      // <-- send objects, not CSV
      })
    })
    .then(res => {
      if (!res.ok) throw new Error("Save failed with status " + res.status);
      return res.text();
    })
    .then(msg => {
      displayElement.innerHTML = "<h3>Vielen Dank für Ihre Teilnahme! Ihre Daten wurden gespeichert.</h3>";
      console.log("Serverantwort:", msg);
    })
    .catch(err => {
      console.error(err);
      // Fallback: participant gets a CSV to email you
      jsPsych.data.get().localSave('csv', 'backup_responses.csv');
      displayElement.innerHTML = `
        <h3>Fehler beim Speichern!</h3>
        <p>Eine CSV wurde heruntergeladen. Bitte senden Sie sie per E-Mail an die Studienleitung.</p>
      `;
    }).finally(() => {
      clearAccumulatedTrials();
      localStorage.removeItem('current_index'); // your step progress
      localStorage.removeItem('all_steps');     // if you store step list
    });
  } else {
    let step = all_steps[index];

    // --- Einwilligung ---
    if(step.type === "consent"){
      jsPsych.run([{
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <h2>Einverständniserklärung</h2>
          <p>Sie nehmen freiwillig an dieser anonymen Online-Studie teil. 
          Es werden keine personenbezogenen Daten erhoben, die Rückschlüsse auf Ihre Identität erlauben. 
          Ihre Daten werden ausschließlich für wissenschaftliche Zwecke anonym ausgewertet.</p>
          <p>Mit Klick auf „Ich stimme zu“ erklären Sie Ihr Einverständnis zur Teilnahme.</p>
        `,
        choices: ["Ich stimme zu", "Ich stimme nicht zu"],
        on_finish: function(data){
          data.section = 'consent';
          appendTrials(jsPsych.data.get().values());
          if(data.response == 0){
            localStorage.setItem("current_index", index+1);
            window.location.reload();
          } else {
            displayElement.innerHTML = "<h3>Sie haben die Teilnahme abgelehnt. Vielen Dank!</h3>";
            localStorage.clear();
          }
        }
      }]);
    }

    // --- Intro ---
    if(step.type === "intro"){
      jsPsych.run([{
        type: jsPsychHtmlButtonResponse,
        stimulus: `
        <h2>Willkommen zur Studie</h2>
        <p>In dieser Studie werden Ihnen nacheinander mehrere Bildpaare gezeigt. 
        Oben auf dem Bildschirm sehen Sie immer ein Basisbild. 
        Darunter erscheinen zwei Varianten, die automatisch generiert wurden.
        Ihre Aufgabe ist es, jeweils die Variante auszuwählen, 
        die Ihrer Einschätzung nach am besten zum Basisbild passt.</p>
        <ul>
          <li>Insgesamt durchlaufen Sie ca. 60 Bildvergleiche.</li>
          <li>Es gibt keine richtigen oder falschen Antworten!</li>
        </ul>
        <p>Wenn Sie bereit sind, klicken Sie auf „Weiter“, um mit den demographischen Fragen zu beginnen.</p>
      `,
        choices: ["Weiter"],
        on_finish: function(data){
          data.section = 'intro';
          appendTrials(jsPsych.data.get().values());
          localStorage.setItem("current_index", index+1);
          window.location.reload();
        }
      }]);
    }

    // --- Demographie ---
    if(step.type === "demographics"){
      jsPsych.run([{
        type: jsPsychSurveyHtmlForm,
        preamble: "<h3>Bitte geben Sie einige demographische Angaben an:</h3>",
        html: `
          <p>Alter: <input name="age" type="number" required></p>
          <p>Geschlecht: 
            <select name="gender" required>
              <option value="">Bitte wählen</option>
              <option value="w">weiblich</option>
              <option value="m">männlich</option>
              <option value="d">divers</option>
            </select>
          </p>
        `,
        on_finish: function(data){
          data.section = 'demographics';
          appendTrials(jsPsych.data.get().values());
          localStorage.setItem("current_index", index+1);
          window.location.reload();
        }
      }]);
    }

    // --- Trial ---
    if(step.type === "trial"){
      let options = [step.option1, step.option2];
      options = jsPsych.randomization.shuffle(options);

      jsPsych.run([{
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div>
            <img src="${step.base}" style="max-width:300px;"><br>
            <p>Welches der beiden Bilder passt Ihrer Einschätzung nach besser zum oberen Bild?</p>
          </div>`,
        choices: [
          `<img src="${options[0]}" style="max-width:260px;">`,
          `<img src="${options[1]}" style="max-width:260px;">`
        ],
        data: {
          section: 'trial',
          base: step.base,
          option1: step.option1,
          option2: step.option2,
          left_image: options[0],
          right_image: options[1]
        },
        on_finish: function(data){
          const choiceIndex = data.response;
          const chosen = choiceIndex === 0 ? data.left_image : data.right_image;
          data.choice_index = choiceIndex;
          data.chosen_image = chosen;
          data.is_option1 = Number(chosen === data.option1);
          data.is_option2 = Number(chosen === data.option2);
          appendTrials(jsPsych.data.get().values());
          localStorage.setItem("current_index", index+1);
          window.location.reload();
        }
      }]);
    }

    // --- Feedback ---
    if(step.type === "feedback"){
      jsPsych.run([{
        type: jsPsychSurveyHtmlForm,
        preamble: "<h3>Optionales Feedback</h3><p>Wenn Sie möchten, können Sie uns hier noch Ihre Kommentare oder Verbesserungsvorschläge hinterlassen:</p>",
        html: `<p><textarea name="feedback" rows="5" style="width:100%;"></textarea></p>`,
        on_finish: function(data){
          data.section = 'feedback';
          appendTrials(jsPsych.data.get().values());
          localStorage.setItem("current_index", index+1);
          window.location.reload();
        }
      }]);
    }

    // --- Ende ---
    if(step.type === "end"){
      localStorage.setItem("current_index", index+1);
      window.location.reload();
    }
  }
</script>
</html>
